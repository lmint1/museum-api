package infrastructure

import config.koinSetup
import gateway.PieceGateway
import kotlinx.serialization.json.Json
import models.PieceItemResponse
import models.PiecesResponse
import org.junit.Rule
import org.junit.Test
import org.koin.test.KoinTest
import org.koin.test.KoinTestRule
import org.koin.test.inject
import kotlin.test.assertEquals
import kotlin.test.assertNotNull

class PieceGatewayImplTest : KoinTest {

    private val gateway: PieceGateway by inject()
    private val json: Json by inject()

    @get:Rule
    val koinTestRule = KoinTestRule.create(koinSetup)

    @Test
    fun get() {
        val pieceDto = gateway.get(297984)
        assertNotNull(pieceDto)
    }

    @Test
    fun getAll() {
        val all = gateway.getAll(5, 1)
        assertEquals(5, all.size)
    }

    @Test
    fun parsePiecesResponse() {
        val jsonStr = "{\"info\":{\"totalrecordsperquery\":5,\"totalrecords\":239026,\"pages\":47806,\"page\":1,\"next\":\"https://api.harvardartmuseums.org/object?page=2&size=5&sort=random&apikey=a\"},\"records\":[{\"copyright\":\"© Lois Conner\",\"contextualtextcount\":0,\"creditline\":\"Harvard Art Museums/Fogg Museum, Gift of Sidney and Shirley Singer\",\"accesslevel\":1,\"dateoflastpageview\":\"2022-02-14\",\"classificationid\":17,\"division\":\"Modern and Contemporary Art\",\"markscount\":0,\"publicationcount\":0,\"totaluniquepageviews\":13,\"contact\":\"am_moderncontemporary@harvard.edu\",\"colorcount\":6,\"rank\":137444,\"state\":null,\"id\":350538,\"verificationleveldescription\":\"Good. Object is well described and information is vetted\",\"period\":null,\"images\":[{\"date\":\"2014-07-03\",\"copyright\":\"President and Fellows of Harvard College\",\"imageid\":442098,\"idsid\":400110717,\"format\":\"image/jpeg\",\"description\":null,\"technique\":\"Make:Sinar Photography AG;Model:Sinar CMV/ Sinarback eVolution 75H;Orientation:1;Software:Adobe Photoshop CS5 Macintosh;\",\"renditionnumber\":\"755993\",\"displayorder\":1,\"baseimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:755993\",\"alttext\":null,\"width\":2450,\"publiccaption\":null,\"iiifbaseuri\":\"https://ids.lib.harvard.edu/ids/iiif/400110717\",\"height\":1073}],\"worktypes\":[{\"worktypeid\":\"269\",\"worktype\":\"photograph\"}],\"imagecount\":1,\"totalpageviews\":14,\"accessionyear\":2013,\"standardreferencenumber\":null,\"signed\":null,\"classification\":\"Photographs\",\"relatedcount\":1,\"verificationlevel\":3,\"primaryimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:755993\",\"titlescount\":2,\"peoplecount\":1,\"style\":null,\"lastupdate\":\"2022-04-05T05:28:32-0400\",\"commentary\":null,\"periodid\":null,\"technique\":\"Gelatin silver print\",\"edition\":\"13/13\",\"description\":null,\"medium\":null,\"lendingpermissionlevel\":0,\"title\":\"Colophon for, \\\"China: Rivers, Mountains and Temples\\\"\",\"accessionmethod\":\"Gift\",\"colors\":[{\"color\":\"#fafafa\",\"spectrum\":\"#955ba5\",\"hue\":\"White\",\"percent\":0.8518974358974359,\"css3\":\"#fffafa\"},{\"color\":\"#e1e1e1\",\"spectrum\":\"#955ba5\",\"hue\":\"Grey\",\"percent\":0.07117948717948717,\"css3\":\"#dcdcdc\"},{\"color\":\"#afafaf\",\"spectrum\":\"#8c5fa8\",\"hue\":\"Grey\",\"percent\":0.039794871794871796,\"css3\":\"#a9a9a9\"},{\"color\":\"#c8c8c8\",\"spectrum\":\"#8c5fa8\",\"hue\":\"Grey\",\"percent\":0.03456410256410256,\"css3\":\"#c0c0c0\"},{\"color\":\"#969696\",\"spectrum\":\"#8761aa\",\"hue\":\"Grey\",\"percent\":0.002358974358974359,\"css3\":\"#a9a9a9\"},{\"color\":\"#7d7d7d\",\"spectrum\":\"#8362aa\",\"hue\":\"Grey\",\"percent\":0.00020512820512820512,\"css3\":\"#808080\"}],\"provenance\":\"Sidney and Shirley Singer, gift; to the Harvard Art Museums, 2013.\",\"groupcount\":0,\"dated\":\"20th century\",\"department\":\"Department of Photographs\",\"dateend\":0,\"people\":[{\"role\":\"Artist\",\"birthplace\":\"New York City, NY\",\"gender\":\"female\",\"displaydate\":\"born 1951\",\"prefix\":null,\"culture\":\"American\",\"displayname\":\"Lois Conner\",\"alphasort\":\"Conner, Lois\",\"name\":\"Lois Conner\",\"personid\":60167,\"deathplace\":null,\"displayorder\":1}],\"url\":\"https://www.harvardartmuseums.org/collections/object/350538\",\"dateoffirstpageview\":\"2020-02-12\",\"century\":\"20th century\",\"objectnumber\":\"2013.176.17\",\"labeltext\":null,\"datebegin\":0,\"culture\":\"American\",\"exhibitioncount\":0,\"imagepermissionlevel\":0,\"mediacount\":0,\"objectid\":350538,\"techniqueid\":123,\"dimensions\":\"sheet: 20 x 46 cm (7 7/8 x 18 1/8 in.)\",\"seeAlso\":[{\"id\":\"https://iiif.harvardartmuseums.org/manifests/object/350538\",\"type\":\"IIIF Manifest\",\"format\":\"application/json\",\"profile\":\"http://iiif.io/api/presentation/2/context.json\"}]},{\"copyright\":null,\"contextualtextcount\":0,\"creditline\":\"Harvard Art Museums/Arthur M. Sackler Museum, The Stuart Cary Welch Collection, Gift of Edith I. Welch in memory of Stuart Cary Welch\",\"accesslevel\":1,\"dateoflastpageview\":\"2020-08-17\",\"classificationid\":21,\"division\":\"Asian and Mediterranean Art\",\"markscount\":0,\"publicationcount\":0,\"totaluniquepageviews\":19,\"contact\":\"am_asianmediterranean@harvard.edu\",\"colorcount\":9,\"rank\":134091,\"state\":null,\"id\":217515,\"verificationleveldescription\":\"Good. Object is well described and information is vetted\",\"period\":null,\"images\":[{\"date\":\"2003-09-24\",\"copyright\":\"President and Fellows of Harvard College\",\"imageid\":138782,\"idsid\":18732959,\"format\":\"image/jpeg\",\"description\":null,\"technique\":null,\"renditionnumber\":\"CARP05422\",\"displayorder\":1,\"baseimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:CARP05422_dynmc\",\"alttext\":null,\"width\":797,\"publiccaption\":null,\"iiifbaseuri\":\"https://ids.lib.harvard.edu/ids/iiif/18732959\",\"height\":1024}],\"worktypes\":[{\"worktypeid\":\"128\",\"worktype\":\"drawing\"}],\"imagecount\":1,\"totalpageviews\":22,\"accessionyear\":2009,\"standardreferencenumber\":null,\"signed\":null,\"classification\":\"Drawings\",\"relatedcount\":0,\"verificationlevel\":3,\"primaryimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:CARP05422_dynmc\",\"titlescount\":1,\"peoplecount\":1,\"style\":null,\"lastupdate\":\"2022-04-05T05:26:06-0400\",\"commentary\":null,\"periodid\":null,\"technique\":null,\"edition\":null,\"description\":\"The drawing depicts a young Kota prince mounted on a horse. His royal status is denoted by the large plume in his turban. Due to the lack of facial hair, which is traditionally worn by Kota rulers, the figure is most likely a prince. He carries a variety of weapons and armor: a shield against his back, a punch-dagger (katar) tucked in his waist sash (patka), a quiver full of arrows, and a sword that peeks out from behind the quiver. Rajput Style, Kota School.\",\"medium\":\"Ink and opaque watercolor on paper; Rajput Style, Kota School\",\"lendingpermissionlevel\":0,\"title\":\"Equestrian Portrait of a Kota Prince\",\"accessionmethod\":\"Gift\",\"colors\":[{\"color\":\"#fae1af\",\"spectrum\":\"#ef7a55\",\"hue\":\"Yellow\",\"percent\":0.8952298850574713,\"css3\":\"#ffdead\"},{\"color\":\"#c8af7d\",\"spectrum\":\"#e9715f\",\"hue\":\"Brown\",\"percent\":0.058045977011494256,\"css3\":\"#d2b48c\"},{\"color\":\"#fafae1\",\"spectrum\":\"#ed765a\",\"hue\":\"Green\",\"percent\":0.018218390804597702,\"css3\":\"#ffffe0\"},{\"color\":\"#323232\",\"spectrum\":\"#2eb45d\",\"hue\":\"Grey\",\"percent\":0.013218390804597701,\"css3\":\"#2f4f4f\"},{\"color\":\"#96967d\",\"spectrum\":\"#8e5ea7\",\"hue\":\"Green\",\"percent\":0.006149425287356322,\"css3\":\"#808080\"},{\"color\":\"#af9664\",\"spectrum\":\"#e9715f\",\"hue\":\"Yellow\",\"percent\":0.003103448275862069,\"css3\":\"#bdb76b\"},{\"color\":\"#7d7d64\",\"spectrum\":\"#6cbd45\",\"hue\":\"Yellow\",\"percent\":0.0022988505747126436,\"css3\":\"#808080\"},{\"color\":\"#4b4b4b\",\"spectrum\":\"#3db657\",\"hue\":\"Grey\",\"percent\":0.001954022988505747,\"css3\":\"#2f4f4f\"},{\"color\":\"#64644b\",\"spectrum\":\"#59ba4a\",\"hue\":\"Green\",\"percent\":0.001781609195402299,\"css3\":\"#696969\"}],\"provenance\":\"Stuart Cary Welch (by 1969 - 2008,) by descent; to his estate (2008-2009,) gift; to Harvard Art Museum.\\r\\n\\r\\nNotes:\\r\\nObject was part of temporary loan to Museum in 1969.\",\"groupcount\":0,\"dated\":\"c. 1740\",\"department\":\"Department of Islamic & Later Indian Art\",\"dateend\":1745,\"people\":[{\"role\":\"Artist\",\"birthplace\":null,\"gender\":\"unknown\",\"displaydate\":null,\"prefix\":null,\"culture\":null,\"displayname\":\"Unknown Artist\",\"alphasort\":\"Unknown Artist\",\"name\":\"Unknown Artist\",\"personid\":23184,\"deathplace\":null,\"displayorder\":1}],\"url\":\"https://www.harvardartmuseums.org/collections/object/217515\",\"dateoffirstpageview\":\"2009-12-04\",\"century\":\"18th century\",\"objectnumber\":\"2009.202.102\",\"labeltext\":null,\"datebegin\":1735,\"culture\":\"Indian\",\"exhibitioncount\":0,\"imagepermissionlevel\":0,\"mediacount\":0,\"objectid\":217515,\"techniqueid\":null,\"dimensions\":\"25.5 x 19.8 cm (10 1/16 x 7 13/16 in.)\",\"seeAlso\":[{\"id\":\"https://iiif.harvardartmuseums.org/manifests/object/217515\",\"type\":\"IIIF Manifest\",\"format\":\"application/json\",\"profile\":\"http://iiif.io/api/presentation/2/context.json\"}]},{\"copyright\":\"© Artists Rights Society (ARS), New York / VG Bild-Kunst, Bonn\",\"contextualtextcount\":0,\"creditline\":\"Harvard Art Museums/Busch-Reisinger Museum, Gift of Julia Feininger\",\"accesslevel\":1,\"dateoflastpageview\":\"2014-12-11\",\"classificationid\":21,\"division\":\"Modern and Contemporary Art\",\"markscount\":0,\"publicationcount\":0,\"totaluniquepageviews\":2,\"contact\":\"am_moderncontemporary@harvard.edu\",\"colorcount\":10,\"rank\":162108,\"state\":null,\"id\":162250,\"verificationleveldescription\":\"Adequate. Object is adequately described but information may not be vetted\",\"period\":null,\"images\":[],\"worktypes\":[{\"worktypeid\":\"128\",\"worktype\":\"drawing\"}],\"imagecount\":1,\"totalpageviews\":2,\"accessionyear\":1963,\"standardreferencenumber\":null,\"signed\":null,\"classification\":\"Drawings\",\"relatedcount\":1,\"verificationlevel\":2,\"primaryimageurl\":null,\"titlescount\":1,\"peoplecount\":1,\"style\":null,\"lastupdate\":\"2022-04-05T05:25:03-0400\",\"commentary\":null,\"periodid\":null,\"technique\":null,\"edition\":null,\"description\":null,\"medium\":\"Colored crayons on paper\",\"lendingpermissionlevel\":0,\"title\":\"Untitled [Ship with Sails]\",\"accessionmethod\":\"Gift\",\"colors\":[{\"color\":\"#e1e1e1\",\"spectrum\":\"#955ba5\",\"hue\":\"Grey\",\"percent\":0.715625,\"css3\":\"#dcdcdc\"},{\"color\":\"#c8c8c8\",\"spectrum\":\"#8c5fa8\",\"hue\":\"Grey\",\"percent\":0.09333333333333334,\"css3\":\"#c0c0c0\"},{\"color\":\"#96967d\",\"spectrum\":\"#8e5ea7\",\"hue\":\"Green\",\"percent\":0.04465277777777778,\"css3\":\"#808080\"},{\"color\":\"#afaf96\",\"spectrum\":\"#8e5ea7\",\"hue\":\"Green\",\"percent\":0.04159722222222222,\"css3\":\"#a9a9a9\"},{\"color\":\"#7d7d64\",\"spectrum\":\"#6cbd45\",\"hue\":\"Yellow\",\"percent\":0.03847222222222222,\"css3\":\"#808080\"},{\"color\":\"#646464\",\"spectrum\":\"#7866ad\",\"hue\":\"Grey\",\"percent\":0.02666666666666667,\"css3\":\"#696969\"},{\"color\":\"#4b4b4b\",\"spectrum\":\"#3db657\",\"hue\":\"Grey\",\"percent\":0.01986111111111111,\"css3\":\"#2f4f4f\"},{\"color\":\"#323232\",\"spectrum\":\"#2eb45d\",\"hue\":\"Grey\",\"percent\":0.009791666666666667,\"css3\":\"#2f4f4f\"},{\"color\":\"#e1e17d\",\"spectrum\":\"#c5d62d\",\"hue\":\"Green\",\"percent\":0.004097222222222223,\"css3\":\"#f0e68c\"},{\"color\":\"#e1c84b\",\"spectrum\":\"#c8d62c\",\"hue\":\"Green\",\"percent\":0.0038888888888888888,\"css3\":\"#f4a460\"}],\"provenance\":null,\"groupcount\":1,\"dated\":\"8/23/1941\",\"department\":\"Busch-Reisinger Museum\",\"dateend\":1941,\"people\":[{\"role\":\"Artist\",\"birthplace\":\"New York, NY\",\"gender\":\"male\",\"displaydate\":\"1871 - 1956\",\"prefix\":null,\"culture\":\"American\",\"displayname\":\"Lyonel Feininger\",\"alphasort\":\"Feininger, Lyonel\",\"name\":\"Lyonel Feininger\",\"personid\":20002,\"deathplace\":\"New York, NY\",\"displayorder\":1}],\"url\":\"https://www.harvardartmuseums.org/collections/object/162250\",\"dateoffirstpageview\":\"2013-09-26\",\"century\":\"20th century\",\"objectnumber\":\"BR63.3437\",\"labeltext\":null,\"datebegin\":1941,\"culture\":\"American\",\"exhibitioncount\":0,\"imagepermissionlevel\":1,\"mediacount\":0,\"objectid\":162250,\"techniqueid\":null,\"dimensions\":\"13.97 x 21.59 cm (5 1/2 x 8 1/2 in.)\",\"seeAlso\":[{\"id\":\"https://iiif.harvardartmuseums.org/manifests/object/162250\",\"type\":\"IIIF Manifest\",\"format\":\"application/json\",\"profile\":\"http://iiif.io/api/presentation/2/context.json\"}]},{\"copyright\":\"© Estate of Joseph Janney Steinmetz\",\"contextualtextcount\":0,\"creditline\":\"Harvard Art Museums/Fogg Museum, Transfer from the Carpenter Center for the Visual Arts, American Professional Photographers Collection\",\"accesslevel\":1,\"dateoflastpageview\":\"2015-11-06\",\"classificationid\":17,\"division\":\"Modern and Contemporary Art\",\"markscount\":0,\"publicationcount\":0,\"totaluniquepageviews\":2,\"contact\":\"am_moderncontemporary@harvard.edu\",\"colorcount\":0,\"rank\":19199,\"state\":null,\"id\":96115,\"verificationleveldescription\":\"Good. Object is well described and information is vetted\",\"period\":null,\"worktypes\":[{\"worktypeid\":\"10\",\"worktype\":\"album page\"},{\"worktypeid\":\"269\",\"worktype\":\"photograph\"}],\"imagecount\":0,\"totalpageviews\":2,\"accessionyear\":2011,\"standardreferencenumber\":null,\"signed\":null,\"classification\":\"Photographs\",\"relatedcount\":1,\"verificationlevel\":3,\"titlescount\":2,\"peoplecount\":1,\"style\":null,\"lastupdate\":\"2022-04-05T05:24:12-0400\",\"commentary\":null,\"periodid\":null,\"technique\":\"Gelatin silver print\",\"edition\":null,\"description\":null,\"medium\":null,\"lendingpermissionlevel\":0,\"title\":\"Untitled (older couple in evening wear outside theatre)\",\"accessionmethod\":\"Transfer\",\"provenance\":null,\"groupcount\":0,\"dated\":\"1937\",\"department\":\"Department of Photographs\",\"dateend\":1937,\"people\":[{\"role\":\"Artist\",\"birthplace\":\"Germantown, PA\",\"gender\":\"male\",\"displaydate\":\"1905 - 1985\",\"prefix\":null,\"culture\":\"American\",\"displayname\":\"Joseph Janney Steinmetz\",\"alphasort\":\"Steinmetz, Joseph Janney\",\"name\":\"Joseph Janney Steinmetz\",\"personid\":22612,\"deathplace\":\"Sarasota, FL\",\"displayorder\":1}],\"url\":\"https://www.harvardartmuseums.org/collections/object/96115\",\"dateoffirstpageview\":\"2015-11-06\",\"century\":\"20th century\",\"objectnumber\":\"4.2002.428.24\",\"labeltext\":null,\"datebegin\":1937,\"culture\":\"American\",\"exhibitioncount\":0,\"imagepermissionlevel\":1,\"mediacount\":0,\"objectid\":96115,\"techniqueid\":123,\"dimensions\":\"image: 19 x 24 cm (7 1/2 x 9 7/16 in.)\"},{\"copyright\":null,\"contextualtextcount\":0,\"creditline\":\"Harvard Art Museums/Arthur M. Sackler Museum, Bequest of the Hofer Collection of the Arts of Asia\",\"accesslevel\":1,\"dateoflastpageview\":\"2022-01-06\",\"classificationid\":75,\"division\":\"Asian and Mediterranean Art\",\"markscount\":0,\"publicationcount\":0,\"totaluniquepageviews\":30,\"contact\":\"am_asianmediterranean@harvard.edu\",\"colorcount\":7,\"rank\":109541,\"state\":null,\"id\":47809,\"verificationleveldescription\":\"Unchecked. Object information has not been verified for completeness and has not been vetted\",\"period\":\"Qing dynasty, 1644-1911\",\"images\":[{\"date\":\"2005-04-26\",\"copyright\":\"President and Fellows of Harvard College\",\"imageid\":53991,\"idsid\":18743858,\"format\":\"image/jpeg\",\"description\":null,\"technique\":null,\"renditionnumber\":\"INV004907\",\"displayorder\":1,\"baseimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:INV004907_dynmc\",\"alttext\":null,\"width\":408,\"publiccaption\":null,\"iiifbaseuri\":\"https://ids.lib.harvard.edu/ids/iiif/18743858\",\"height\":1024}],\"worktypes\":[{\"worktypeid\":\"73\",\"worktype\":\"calligraphy\"},{\"worktypeid\":\"9\",\"worktype\":\"album leaf\"}],\"imagecount\":1,\"totalpageviews\":42,\"accessionyear\":1985,\"standardreferencenumber\":null,\"signed\":null,\"classification\":\"Calligraphy\",\"relatedcount\":1,\"verificationlevel\":0,\"primaryimageurl\":\"https://nrs.harvard.edu/urn-3:HUAM:INV004907_dynmc\",\"titlescount\":1,\"peoplecount\":0,\"style\":null,\"lastupdate\":\"2022-04-05T05:23:49-0400\",\"commentary\":null,\"periodid\":398,\"technique\":null,\"edition\":null,\"description\":null,\"medium\":\"Album leaf; ink on paper\",\"lendingpermissionlevel\":0,\"title\":\"Calligraphy Album Leaf\",\"accessionmethod\":\"Bequest\",\"colors\":[{\"color\":\"#e1c8af\",\"spectrum\":\"#e9715f\",\"hue\":\"Orange\",\"percent\":0.7958192090395481,\"css3\":\"#f5deb3\"},{\"color\":\"#fae1af\",\"spectrum\":\"#ef7a55\",\"hue\":\"Yellow\",\"percent\":0.07988700564971751,\"css3\":\"#ffdead\"},{\"color\":\"#c8af96\",\"spectrum\":\"#e66c64\",\"hue\":\"Brown\",\"percent\":0.04813559322033898,\"css3\":\"#d2b48c\"},{\"color\":\"#af967d\",\"spectrum\":\"#c25687\",\"hue\":\"Brown\",\"percent\":0.022937853107344634,\"css3\":\"#bc8f8f\"},{\"color\":\"#64644b\",\"spectrum\":\"#59ba4a\",\"hue\":\"Green\",\"percent\":0.02056497175141243,\"css3\":\"#696969\"},{\"color\":\"#967d64\",\"spectrum\":\"#b65590\",\"hue\":\"Brown\",\"percent\":0.016497175141242937,\"css3\":\"#808080\"},{\"color\":\"#7d6464\",\"spectrum\":\"#8e5ea7\",\"hue\":\"Brown\",\"percent\":0.01615819209039548,\"css3\":\"#696969\"}],\"provenance\":\"Hong Kong/London April/76\",\"groupcount\":0,\"dated\":null,\"department\":\"Department of Asian Art\",\"dateend\":0,\"url\":\"https://www.harvardartmuseums.org/collections/object/47809\",\"dateoffirstpageview\":\"2009-07-10\",\"century\":null,\"objectnumber\":\"1985.914.14\",\"labeltext\":null,\"datebegin\":0,\"culture\":\"Chinese\",\"exhibitioncount\":0,\"imagepermissionlevel\":0,\"mediacount\":0,\"objectid\":47809,\"techniqueid\":null,\"dimensions\":null,\"seeAlso\":[{\"id\":\"https://iiif.harvardartmuseums.org/manifests/object/47809\",\"type\":\"IIIF Manifest\",\"format\":\"application/json\",\"profile\":\"http://iiif.io/api/presentation/2/context.json\"}]}]}"
        val response = json.decodeFromJsonElement(
            PiecesResponse.serializer(),
            json.parseToJsonElement(jsonStr)
        )
        println(response)
    }

    @Test
    fun parsePieceItemResponse() {
        val jsonStr = "{ \"id\": 10000,\"title\": null,\"culture\": null,\"dated\": null,\"classification\": null,\"images\": null,\"people\": null }"
        val response = json.decodeFromJsonElement(
            PieceItemResponse.serializer(),
            json.parseToJsonElement(jsonStr)
        )
        println(response)
    }

}